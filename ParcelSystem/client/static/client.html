<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Parcel Client â€” Scan & Preview</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <script src="https://unpkg.com/html5-qrcode"></script>

  <style>
    body{font-family:Inter,system-ui,Segoe UI,Roboto,sans-serif;margin:0;background:#f4f6f9;color:#222}
    .wrap{max-width:900px;margin:24px auto;padding:16px}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .server{font-size:14px;color:#666}
    .card{background:#fff;border-radius:10px;padding:16px;box-shadow:0 8px 20px rgba(12,20,40,.06);margin-bottom:12px}
    input.scan{width:100%;padding:14px;border:2px dashed #cfd8e3;border-radius:8px;font-size:18px}
    input.scan:disabled{background:#f0f0f0}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    button.btn{background:#f95e07;color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer}
    button.btn:disabled{opacity:.6;cursor:not-allowed}
    button.ghost{background:#fff;border:1px solid #e6eef6;color:#345395}
    button.danger{background:#e74c3c}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:8px;border-bottom:1px solid #eef2f6;text-align:left}
    .muted{color:#666;font-size:13px}
    #reader{width:100%;max-width:360px;margin-top:12px}

    /* highlight à¸¥à¹ˆà¸²à¸ªà¸¸à¸” */
    tr.latest{background:#fff6e5;animation:flash .4s}
    @keyframes flash{from{background:#ffe0b2}to{background:#fff6e5}}
  </style>
</head>

<body>
<div class="wrap">

<header>
  <h2>Parcel Client â€” Scan & Preview</h2>
  <div class="server">Server: <span id="serverUrl"></span></div>
</header>

<div class="card">
  <input id="scanInput" class="scan" placeholder="à¸›à¹‰à¸­à¸™à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸”à¹‰à¸§à¸¢à¸•à¸™à¹€à¸­à¸‡ (à¹„à¸¡à¹ˆà¸šà¸±à¸‡à¸„à¸±à¸š)" autocomplete="off" />

  <div class="row" style="margin-top:10px">
    <button class="btn ghost" onclick="startCamera()">ðŸ“· Open Camera</button>
    <button class="btn danger" onclick="stopCamera()">âœ– Stop Camera</button>

    <div class="muted" style="margin-left:auto">
      Preview: <strong id="previewCount">0</strong>
    </div>

    <button class="btn" id="confirmAllBtn" onclick="confirmAll()" disabled>
      Confirm All
    </button>
  </div>

  <div id="reader"></div>
  <div id="messages" style="margin-top:8px"></div>
</div>

<div class="card">
  <strong>Preview</strong>
  <table>
    <thead>
      <tr><th>#</th><th>Tracking</th><th>Queue</th><th>Status</th><th></th></tr>
    </thead>
    <tbody id="previewBody"></tbody>
  </table>
</div>

</div>

<script>
/* ---------------- CONFIG ---------------- */
const SERVER = location.origin;
document.getElementById('serverUrl').innerText = SERVER;

/* ---------------- STATE ---------------- */
const scanInput = document.getElementById('scanInput');
const previewBody = document.getElementById('previewBody');
const previewCount = document.getElementById('previewCount');
const confirmAllBtn = document.getElementById('confirmAllBtn');
const messages = document.getElementById('messages');

let preview = JSON.parse(localStorage.getItem('preview') || '[]');
let qrScanner = null;
let scanningLocked = false;
let busy = false;

/* ---------------- SOUND + VIBRATE ---------------- */
function beep(type="ok"){
  const ctx=new (window.AudioContext||window.webkitAudioContext)();
  const osc=ctx.createOscillator();
  const gain=ctx.createGain();
  osc.connect(gain);gain.connect(ctx.destination);

  if(type==="ok"){osc.frequency.value=880;gain.gain.value=.15;osc.start();osc.stop(ctx.currentTime+.12);}
  else{osc.frequency.value=220;gain.gain.value=.25;osc.start();osc.stop(ctx.currentTime+.25);}
}
function vibrate(){ if(navigator.vibrate) navigator.vibrate(100); }

/* ---------------- KEYBOARD ---------------- */
scanInput.addEventListener('keydown',e=>{
  if(e.key==="Enter"){
    const v=scanInput.value.trim();
    scanInput.value='';
    handleScan(v);
  }
});

/* ---------------- CAMERA ---------------- */
function startCamera(){
  if(qrScanner) return;
  scanningLocked=false;
  qrScanner=new Html5Qrcode("reader");

  Html5Qrcode.getCameras().then(cams=>{
    if(!cams.length){flashMsg("No camera",false);return;}
    qrScanner.start(cams[cams.length-1].id,{fps:10,qrbox:250},
      text=>{
        if(scanningLocked) return;
        scanningLocked=true;
        handleScan(text).finally(()=>setTimeout(stopCamera,300));
      });
  });
}

function stopCamera(){
  if(!qrScanner) return;
  qrScanner.stop().then(()=>{qrScanner.clear();qrScanner=null;scanningLocked=false;});
}

/* ---------------- CORE ---------------- */
async function handleScan(tracking){
  if(!tracking||busy) return;
  busy=true; scanInput.disabled=true;

  try{
    if(preview.find(p=>p.tracking===tracking)){
      beep("error");flashMsg("Already scanned",false);return;
    }

    const res=await fetch(`${SERVER}/api/parcels`,{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({tracking_number:tracking,provisional:true})
    });

    if(res.status===409){
      const d=await fetch(`${SERVER}/api/parcels/${tracking}`).then(r=>r.json());
      addPreview(d.tracking_number,d.queue_number,d.status);
      beep("ok");vibrate();return;
    }

    const j=await res.json();
    addPreview(tracking,j.queue_number,'PENDING');
    beep("ok");vibrate();
  }catch(e){
    beep("error");flashMsg(e.message,false);
  }finally{
    busy=false;scanInput.disabled=false;scanInput.focus();
  }
}

function addPreview(tracking,queue,status){
  preview.unshift({tracking,queue,status});
  savePreview(); renderPreview();
}

function renderPreview(){
  previewBody.innerHTML='';
  preview.forEach((p,i)=>{
    previewBody.innerHTML+=`
      <tr class="${i===0?'latest':''}">
        <td>${i+1}</td>
        <td>${p.tracking}</td>
        <td>${p.queue||''}</td>
        <td>${p.status}</td>
        <td><button onclick="removeAt(${i})">Remove</button></td>
      </tr>`;
  });
  previewCount.innerText=preview.length;
  confirmAllBtn.disabled=!preview.length;
}

function removeAt(i){preview.splice(i,1);savePreview();renderPreview();}

/* ---------------- CONFIRM ---------------- */
async function confirmAll(){
  confirmAllBtn.disabled=true;
  for(const p of preview){
    await fetch(`${SERVER}/api/parcels/${p.tracking}/confirm_pending`,{method:'POST'});
  }
  preview=[];savePreview();renderPreview();
  flashMsg("Confirmed all",true);
}

/* ---------------- OFFLINE ---------------- */
function savePreview(){localStorage.setItem("preview",JSON.stringify(preview));}

/* ---------------- UTIL ---------------- */
function flashMsg(t,ok=true){
  messages.innerHTML=`<strong>${ok?'âœ”':'âœ–'}</strong> ${t}`;
  messages.style.color=ok?'#2ecc71':'#e74c3c';
  setTimeout(()=>messages.innerHTML='',3000);
}

/* ---------------- INIT ---------------- */
window.onload=()=>{
  renderPreview();
  scanInput.focus();
};
</script>
</body>
</html>
