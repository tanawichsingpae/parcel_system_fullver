<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>ParcelServer — Admin</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:Inter,system-ui,Segoe UI,Roboto,sans-serif;margin:0;background:#f3f6f9;color:#222}
    header{background:#345395;color:#fff;padding:18px 24px}
    .container{max-width:1100px;margin:22px auto;padding:12px}
    .card{background:#fff;border-radius:12px;padding:16px;margin-bottom:12px;box-shadow:0 8px 22px rgba(20,30,60,0.06)}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .btn{background:#f95e07;color:#fff;padding:10px 14px;border-radius:8px;border:none;cursor:pointer}
    input,select{padding:8px;border-radius:8px;border:1px solid #ddd}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #eee;text-align:left}
    .muted{color:#666;font-size:13px}
    nav.tabs{display:flex;gap:8px;margin-bottom:12px}
    nav.tabs button{background:#fff;padding:10px 14px;border-radius:10px;border:1px solid #e6e6e6;cursor:pointer}
    nav.tabs button.active{background:#345395;color:#fff;border-color:#345395}
    .flex{display:flex;gap:12px;align-items:center}
    .scan-input{font-size:18px;padding:10px;border-radius:8px;border:2px dashed #ccc;min-width:320px}
    .small{font-size:13px;color:#444}
    .pill{display:inline-block;background:#fff;padding:10px;border-radius:12px;box-shadow:0 8px 18px rgba(0,0,0,0.06);margin-right:8px}
  </style>
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<header><h1>ParcelServer — Admin</h1></header>
<div class="container">
  <nav class="tabs" id="mainTabs">
    <button class="tabBtn active" data-tab="checkout">Checkout</button>
    <button class="tabBtn" data-tab="reports">Reports</button>
  </nav>

  <!-- CHECKOUT TAB -->
  <div id="checkout" class="tabContent">
    <div class="card">
      <strong>Checkout (Double-scan)</strong>
      <div class="muted">Scan to verify, then scan again to confirm pickup. หรือค้นหาก่อนยืนยัน</div>

      <div style="margin-top:10px">
        <div class="small">Scanner input (keyboard-wedge):</div>
        <input id="scanInput" class="scan-input" placeholder="Scan tracking here and press Enter" />
        <div style="margin-top:8px" class="small">Status: <span id="scanStatus">waiting</span></div>
        <div style="margin-top:12px"><button class="btn" onclick="forceClearPending()">Clear</button></div>
      </div>

      <div id="pendingBox" style="margin-top:12px"></div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <strong>Search / Quick Lookup</strong>
          <div class="muted">ค้นหาโดย tracking หรือ queue</div>
        </div>
        <div class="flex">
          <input id="searchInput" placeholder="tracking or queue" />
          <button class="btn" onclick="doSearch()">Search</button>
        </div>
      </div>
      <div id="searchResults" style="margin-top:12px"></div>
    </div>

    <div class="card">
      <strong>Detailed view / History</strong>
      <div id="detailView" class="muted">เลือกพัสดุแล้วจะขึ้นรายละเอียดที่นี่</div>
    </div>
  </div>

  <!-- REPORTS TAB -->
  <div id="reports" class="tabContent" style="display:none">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <strong>Reports</strong>
          <div class="muted">ดูสรุปยอด และส่งออกไฟล์ CSV / XLSX</div>
        </div>

        <div class="row">
          <select id="r_period">
            <option value="daily">Daily</option>
            <option value="monthly">Monthly</option>
            <option value="yearly">Yearly</option>
          </select>
          <select id="r_periodValues"></select>
          <button class="btn" onclick="loadReport()">Open</button>
          <button class="btn" onclick="exportReport('csv')">Export CSV</button>
          <button class="btn" onclick="exportReport('xlsx')">Export XLSX</button>
        </div>
      </div>

      <div id="summary" style="margin-top:12px"></div>
    </div>

    <div class="card">
      <strong>Summary chart</strong>
      <canvas id="summaryChart" height="120"></canvas>
    </div>

    <div class="card">
      <strong>Report data (preview)</strong>
      <div id="reportTable"></div>
    </div>
  </div>

</div>

<script>
/* Tabs */
document.querySelectorAll('.tabBtn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.tabBtn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const tab = btn.dataset.tab;
    document.querySelectorAll('.tabContent').forEach(tc=>tc.style.display = tc.id===tab ? 'block' : 'none');
    if(tab === 'reports') initReports();
  });
});

/* ---------- Checkout logic (double-scan) ---------- */
let pendingVerification = null;
document.getElementById('scanInput').addEventListener('keypress', (e)=>{
  if(e.key === 'Enter') handleScan(document.getElementById('scanInput').value.trim());
});

async function handleScan(value){
  if(!value) return;
  if(!pendingVerification){
    // first scan -> verify
    const res = await fetch(`/api/parcels/${encodeURIComponent(value)}/verify`, {method:'POST'});
    if(!res.ok){ document.getElementById('scanStatus').innerText = 'Verify failed'; document.getElementById('scanInput').value=''; return; }
    const info = await res.json();
    pendingVerification = {tracking: info.tracking, queue: info.queue_number, recipient: info.recipient_name, ts: Date.now()};
    document.getElementById('pendingBox').innerHTML = `<div style="padding:12px;border-radius:8px;background:#fff7ed;border:1px solid #f2c6a0">
      <div><strong>Pending:</strong> ${info.tracking} <small>[${info.queue_number}]</small></div>
      <div class="small">Recipient: ${info.recipient_name || '---'}</div>
      <div class="small">Scan again the same tracking to confirm pickup</div>
    </div>`;
    document.getElementById('scanStatus').innerText = 'Verified — waiting for second scan';
    document.getElementById('scanInput').value = '';
    // also show details
    showDetail(info);
    return;
  }

  // second scan -> confirm only if match
  if(value === pendingVerification.tracking){
    const res = await fetch(`/api/parcels/${encodeURIComponent(value)}/confirm_pickup`, {method:'POST'});
    const j = await res.json();
    if(j.ok){ document.getElementById('scanStatus').innerText = `Confirmed pickup ${value}`; pendingVerification = null; document.getElementById('pendingBox').innerHTML = `<div class="small">Confirmed ${value}</div>`; document.getElementById('scanInput').value=''; }
    else { document.getElementById('scanStatus').innerText = j.message || 'Confirm failed'; }
    return;
  } else {
    document.getElementById('scanStatus').innerText = `Mismatch: scanned ${value} (expected ${pendingVerification.tracking})`;
    document.getElementById('scanInput').value = '';
    // do not clear pending automatically
    return;
  }
}

function forceClearPending(){ pendingVerification = null; document.getElementById('pendingBox').innerHTML = ''; document.getElementById('scanStatus').innerText = 'cleared'; }

/* Search */
document.getElementById('searchInput').addEventListener('keypress', (e)=>{ if(e.key==='Enter') doSearch(); });
async function doSearch(){
  const q = document.getElementById('searchInput').value.trim();
  if(!q) return alert('Please input tracking or queue');
  const res = await fetch(`/api/parcels/search?q=${encodeURIComponent(q)}`);
  if(!res.ok) return alert('Search failed');
  const data = await res.json();
  if(data.count === 0) { document.getElementById('searchResults').innerHTML = '<div class="muted">No results</div>'; return; }
  // render table
  const rows = data.items.map(i=>`<tr><td>${i.tracking}</td><td>${i.queue}</td><td>${i.status}</td><td>${i.recipient||''}</td>
    <td><button onclick="verify('${i.tracking}')">Verify</button> <button onclick="confirmPickup('${i.tracking}')">Confirm</button></td></tr>`).join('');
  document.getElementById('searchResults').innerHTML = `<table><thead><tr><th>tracking</th><th>queue</th><th>status</th><th>recipient</th><th>action</th></tr></thead><tbody>${rows}</tbody></table>`;
}

/* manual verify/confirm from search results */
async function verify(tracking){
  const res = await fetch(`/api/parcels/${encodeURIComponent(tracking)}/verify`, {method:'POST'});
  if(!res.ok) return alert('verify failed');
  const info = await res.json();
  pendingVerification = {tracking: info.tracking, queue: info.queue_number, recipient: info.recipient_name, ts: Date.now()};
  document.getElementById('pendingBox').innerHTML = `<div style="padding:12px;border-radius:8px;background:#fff7ed;border:1px solid #f2c6a0">
    <div><strong>Pending:</strong> ${info.tracking} <small>[${info.queue_number}]</small></div>
    <div class="small">Recipient: ${info.recipient_name || '---'}</div>
    <div class="small">Scan again the same tracking to confirm pickup</div>
  </div>`;
  document.getElementById('scanStatus').innerText = 'Verified — waiting for second scan';
  showDetail(info);
}

async function confirmPickup(tracking){
  if(!confirm('Confirm pickup?')) return;
  const res = await fetch(`/api/parcels/${encodeURIComponent(tracking)}/confirm_pickup`, {method:'POST'});
  const j = await res.json();
  alert(JSON.stringify(j));
  // optionally refresh UI
}

/* show detailed info */
function showDetail(info){
  document.getElementById('detailView').innerHTML = `<div><strong>Tracking:</strong> ${info.tracking}</div>
    <div><strong>Queue:</strong> ${info.queue}</div>
    <div><strong>Recipient:</strong> ${info.recipient || '---'}</div>
    <div class="small">(You can verify name vs student card before confirming)</div>`;
}

/* ---------- Reports logic (chart + export) ---------- */
let chartInst = null;
let currentReportData = null;

async function initReports(){
  // load period values if not loaded
  await loadReportValues();
  // optionally auto open today
  // loadReport();
}

async function loadReportValues(){
  const p = document.getElementById('r_period').value;
  const res = await fetch(`/api/reports/dates?period=${p}`);
  if(!res.ok) return;
  const arr = await res.json();
  const sel = document.getElementById('r_periodValues');
  sel.innerHTML = '';
  if(arr.length === 0){ sel.add(new Option('No data','')); return; }
  arr.forEach(r=>{
    let label = r.period;
    if(p === 'daily' && label.length===8) label = `${label.slice(0,4)}-${label.slice(4,6)}-${label.slice(6)}`;
    if(p === 'monthly' && label.length===6) label = `${label.slice(0,4)}-${label.slice(4,6)}`;
    sel.add(new Option(`${label} (${r.count})`, r.period));
  });
}

document.getElementById('r_period').addEventListener('change', loadReportValues);

async function loadReport(){
  const p = document.getElementById('r_period').value;
  const val = document.getElementById('r_periodValues').value || '';
  // fetch summary
  const sres = await fetch(`/api/reports/summary?period=${encodeURIComponent(p)}&date=${encodeURIComponent(val)}`);
  const sdata = await sres.json();
  document.getElementById('summary').innerHTML = `<div style="display:flex;gap:12px">
    <div class="pill">Check-in: <strong>${sdata.checkin}</strong></div>
    <div class="pill">Check-out: <strong>${sdata.checkout}</strong></div>
    <div class="pill">Remaining: <strong>${sdata.remaining}</strong></div>
  </div>`;
  renderReportTable(sdata.items);

  // fetch timeseries for chart (we can request last N points; server returns labels & arrays)
  const tres = await fetch(`/api/reports/timeseries?period=${encodeURIComponent(p)}&start=${encodeURIComponent(val)}`);
  const tdata = await tres.json();
  currentReportData = tdata;
  renderChart(tdata.labels, tdata.checkin, tdata.checkout, p);
}

function renderReportTable(items){
  if(!items || items.length===0){ document.getElementById('reportTable').innerHTML = '<div class="muted">No items</div>'; return; }
  const rows = items.map(i=>`<tr><td>${i.tracking}</td><td>${i.queue}</td><td>${i.status}</td><td>${i.recipient||''}</td></tr>`).join('');
  document.getElementById('reportTable').innerHTML = `<table><thead><tr><th>tracking</th><th>queue</th><th>status</th><th>recipient</th></tr></thead><tbody>${rows}</tbody></table>`;
}

function renderChart(labels, checkin, checkout, period){
  // convert labels to readable format
  const formattedLabels = labels.map(l=>{
    if(period==='daily' && l.length===8) return `${l.slice(0,4)}-${l.slice(4,6)}-${l.slice(6)}`;
    if(period==='monthly' && l.length===6) return `${l.slice(0,4)}-${l.slice(4,6)}`;
    return l;
  });

  const ctx = document.getElementById('summaryChart').getContext('2d');
  if(chartInst) chartInst.destroy();
  chartInst = new Chart(ctx, {
    type: 'line',
    data: {
      labels: formattedLabels,
      datasets: [
        { label: 'Check-in', data: checkin, fill: false, tension: 0.2 },
        { label: 'Check-out', data: checkout, fill: false, tension: 0.2 }
      ]
    },
    options: {
      responsive: true,
      scales: { y: { beginAtZero: true } }
    }
  });
}

/* Export */
function exportReport(fmt){
  const p = document.getElementById('r_period').value;
  const val = document.getElementById('r_periodValues').value || '';
  window.open(`/api/reports/export?period=${encodeURIComponent(p)}&date=${encodeURIComponent(val)}&fmt=${fmt}`, '_blank');
}
</script>
</body>
</html>
